# Voxa Content Refinement - Testing Guide (Rails Console)

**Date:** August 19, 2025  
**Author:** Claude Code AI  
**Purpose:** Step-by-step guide to test Voxa implementation using Rails Console

---

This guide will allow you to manually test each component of the Voxa integration, from data preparation to refined content generation. Follow the steps in order to understand the complete flow and verify that everything works correctly.

---

## 🔐 0. Initial Setup: Prepare User and Brand

First you need a user with a brand and a strategy plan generated by Noctua:

```ruby
# Find or create user
user = User.find_by(email: "your_email@example.com")

# If it doesn't exist, create a test one
unless user
  user = User.create!(
    email: "test@example.com",
    password: "password123",
    first_name: "Test",
    last_name: "User"
  )
end

# Verify that the user exists
puts "👤 User: #{user.email} (ID: #{user.id})"
```

```ruby
# Create a complete brand for the user
brand = Brand.create!(
  user: user,
  name: "TestBrand Co",
  slug: "testbrand-co",
  industry: "Technology",
  value_proposition: "Accessible technological innovation",
  mission: "Democratize technology for everyone",
  voice: "friendly",
  content_language: "en-US",
  banned_words_list: "",
  guardrails: {
    "banned_words" => [],
    "tone_no_go" => ["aggressive", "promotional"],
    "claims_rules" => "Don't make medical claims"
  }
)

puts "🏢 Brand created: #{brand.name} (ID: #{brand.id})"
```

```ruby
# Create brand channels (needed to extract priority_platforms)
instagram_channel = BrandChannel.create!(
  brand: brand,
  platform: :instagram,
  handle: "@testbrand",
  is_active: true
)

tiktok_channel = BrandChannel.create!(
  brand: brand,
  platform: :tiktok, 
  handle: "@testbrand_tiktok",
  is_active: true
)

puts "📱 Channels created: Instagram, TikTok"
```

---

## 📋 1. Create Strategy Plan with Noctua Data

You need a `CreasStrategyPlan` with realistic Noctua data in the `raw_payload` field:

```ruby
# Example payload that simulates data generated by Noctua
noctua_payload = {
  "brand_name" => "TestBrand Co",
  "brand_slug" => "testbrand-co",
  "strategy_name" => "August 2025 Strategy",
  "month" => "2025-08",
  "general_theme" => "Technological Innovation",
  "objective_of_the_month" => "awareness",
  "frequency_per_week" => 3,
  "platforms" => ["Instagram", "TikTok"],
  "tone_style" => "Friendly but professional",
  "content_language" => "en-US",
  "account_language" => "en-US",
  "target_region" => "United States",
  "timezone" => "America/New_York",
  "post_types" => ["Video", "Image", "Carousel"],
  "weekly_plan" => [
    {
      "week" => 1,
      "publish_cadence" => 3,
      "ideas" => [
        {
          "id" => "202508-testbrand-co-w1-i1-C",
          "status" => "draft",
          "title" => "Tech Innovation for Everyone",
          "hook" => "Did you know technology can be more accessible?",
          "description" => "We explain how new technologies are becoming more accessible to the common user, breaking traditional barriers.",
          "platform" => "Instagram Reels", 
          "pilar" => "C",
          "recommended_template" => "only_avatars",
          "video_source" => "none",
          "visual_notes" => "Avatar speaking directly to camera",
          "kpi_focus" => "reach",
          "success_criteria" => "≥10K views",
          "beats_outline" => ["Hook: Provocative question", "Value: 3 concrete examples", "CTA: Comment your experience"],
          "cta" => "What's your favorite technology? Let us know 👇"
        },
        {
          "id" => "202508-testbrand-co-w1-i2-R",
          "status" => "draft", 
          "title" => "Real Success Stories",
          "hook" => "This is what happened when Maria tried our solution...",
          "description" => "Success story of a real user who transformed her workflow using our technological tools.",
          "platform" => "Instagram Reels",
          "pilar" => "R", 
          "recommended_template" => "narration_over_7_images",
          "video_source" => "none",
          "visual_notes" => "Before/after process images",
          "kpi_focus" => "saves",
          "success_criteria" => "≥8% saves",
          "beats_outline" => ["Hook: Personal story", "Problem: Initial situation", "Solution: Step by step process", "Result: Transformation", "Social proof: Testimonials", "Benefit: Value obtained", "CTA: Try it yourself"],
          "cta" => "Save this post and tell us your story 💾"
        },
        {
          "id" => "202508-testbrand-co-w1-i3-E",
          "status" => "draft",
          "title" => "Scalability Tutorial",
          "hook" => "3 steps to scale your tech project without breaking the budget",
          "description" => "Practical tutorial on how to grow a technological project in a sustainable and economical way.",
          "platform" => "Instagram Reels",
          "pilar" => "E",
          "recommended_template" => "avatar_and_video", 
          "video_source" => "external",
          "visual_notes" => "Avatar + tool clips",
          "kpi_focus" => "saves",
          "success_criteria" => "≥12% saves",
          "beats_outline" => ["Hook: Specific promise", "Step 1: Planning", "Step 2: Automation", "Step 3: Optimization", "CTA: Implement today"],
          "cta" => "Which one will you implement first? 🚀"
        }
      ]
    }
  ]
}

puts "📊 Noctua payload prepared with #{noctua_payload['weekly_plan'][0]['ideas'].length} ideas"
```

```ruby
# Create the strategy plan
strategy_plan = CreasStrategyPlan.create!(
  user: user,
  brand: brand,
  month: "2025-08",
  objective_of_the_month: "awareness",
  frequency_per_week: 3,
  raw_payload: noctua_payload,
  monthly_themes: ["Innovation", "Accessibility", "Democratization"],
  brand_snapshot: {
    "name" => brand.name,
    "industry" => brand.industry,
    "voice" => brand.voice
  }
)

puts "📈 Strategy plan created: #{strategy_plan.id}"
puts "   Month: #{strategy_plan.month}"
puts "   Objective: #{strategy_plan.objective_of_the_month}"
puts "   Frequency: #{strategy_plan.frequency_per_week} posts/week"
```

---

## 🔍 2. Verify StrategyPlanFormatter

Before calling Voxa, verify that the formatter works correctly:

```ruby
# Create formatter and test the for_voxa method
formatter = Creas::StrategyPlanFormatter.new(strategy_plan)
formatted_data = formatter.for_voxa

puts "📋 Data formatted for Voxa:"
puts "   Brand: #{formatted_data.dig("strategy", "brand_name")}"
puts "   Month: #{formatted_data.dig("strategy", "month")}"
puts "   Ideas: #{formatted_data.dig("strategy", "weekly_plan", 0, "ideas")&.length || 0}"

# Show first idea as example
first_idea = formatted_data.dig("strategy", "weekly_plan", 0, "ideas", 0)
if first_idea
  puts "\n📝 First idea:"
  puts "   ID: #{first_idea["id"]}"
  puts "   Title: #{first_idea["title"]}"
  puts "   Template: #{first_idea["recommended_template"]}"
  puts "   Pillar: #{first_idea["pilar"]}"
end
```

---

## 🤖 3. Test Brand Context Construction

The service needs to build a brand context that is sent along with the strategy data:

```ruby
# Initialize the Voxa service
service = Creas::VoxaContentService.new(strategy_plan: strategy_plan)

# Test brand context construction (private method)
brand_context = service.send(:build_brand_context, brand)

puts "🏢 Brand context constructed:"
puts "   Industry: #{brand_context.dig("brand", "industry")}"
puts "   Value proposition: #{brand_context.dig("brand", "value_proposition")}"
puts "   Platforms: #{brand_context.dig("brand", "priority_platforms")&.join(", ")}"
puts "   Language: #{brand_context.dig("brand", "languages", "content_language")}"

# Verify guardrails
guardrails = brand_context.dig("brand", "guardrails")
puts "   Configured guardrails: #{guardrails&.keys&.join(", ") || "none"}"
```

---

## ⚙️ 4. Verify Voxa Prompts

Before calling the API, verify that the prompts are generated correctly:

```ruby
# Get the necessary data
strategy_plan_data = formatter.for_voxa
brand_context = service.send(:build_brand_context, brand)

# Generate system prompt
system_prompt = Creas::Prompts.voxa_system(strategy_plan_data: strategy_plan_data)

puts "🔧 System prompt generated:"
puts "   Length: #{system_prompt.length} characters"
puts "   Contains version: #{system_prompt.include?(Creas::Prompts::VOXA_VERSION)}"
puts "   Contains contract: #{system_prompt.include?("ITEM_OBJ")}"

# Generate user prompt
user_prompt = Creas::Prompts.voxa_user(strategy_plan_data: strategy_plan_data, brand_context: brand_context)

puts "\n👤 User prompt generated:"
puts "   Length: #{user_prompt.length} characters"
puts "   Contains strategy data: #{user_prompt.include?("Strategy Plan Data")}"
puts "   Contains brand context: #{user_prompt.include?("Brand Context")}"

# Show first lines to verify format
puts "\n📄 First lines of user prompt:"
puts user_prompt.lines[0..5].map(&:strip).join("\n")
```

---

## 🚀 5. Execute Voxa Service (Mocked)

To test without consuming real API, we can simulate the OpenAI response:

```ruby
# Simulated response that Voxa should generate
mock_voxa_response = {
  "items" => [
    {
      "id" => "20250819-w1-i1",
      "origin_id" => "202508-testbrand-co-w1-i1-C",
      "origin_source" => "weekly_plan",
      "week" => 1,
      "week_index" => 1,
      "content_name" => "Accessible Tech Innovation",
      "status" => "in_production",
      "creation_date" => Date.current.iso8601,
      "publish_date" => (Date.current + 4.days).iso8601,
      "publish_datetime_local" => (Date.current + 4.days).strftime("%Y-%m-%dT18:00:00"),
      "timezone" => "America/New_York",
      "content_type" => "Video",
      "platform" => "Instagram Reels",
      "aspect_ratio" => "9:16",
      "language" => "en-US",
      "pilar" => "C",
      "template" => "only_avatars",
      "video_source" => "none",
      "post_description" => "Educational content about technological accessibility for general audiences",
      "text_base" => "Did you know technology can be more accessible? Here I explain 3 ways to democratize access to digital tools. Which is your favorite? 👇",
      "hashtags" => "#technology #innovation #accessibility #digital",
      "subtitles" => { "mode" => "platform_auto", "languages" => ["en-US"] },
      "dubbing" => { "enabled" => false, "languages" => [] },
      "shotplan" => {
        "scenes" => [
          {
            "id" => 1,
            "role" => "Hook",
            "type" => "avatar",
            "visual" => "Avatar in close-up, soft technological background",
            "on_screen_text" => "ACCESSIBLE TECHNOLOGY?",
            "voiceover" => "Did you know technology can be more accessible than you think?",
            "avatar_id" => "avatar_sarah",
            "voice_id" => "voice_en_female_1"
          },
          {
            "id" => 2,
            "role" => "Development", 
            "type" => "avatar",
            "visual" => "Explanatory avatar with natural gestures",
            "on_screen_text" => "3 WAYS TO DEMOCRATIZE",
            "voiceover" => "I'm going to explain three concrete ways to democratize access to digital tools",
            "avatar_id" => "avatar_sarah",
            "voice_id" => "voice_en_female_1"
          },
          {
            "id" => 3,
            "role" => "Close",
            "type" => "avatar",
            "visual" => "Smiling avatar, call to action",
            "on_screen_text" => "WHICH DO YOU PREFER?",
            "voiceover" => "Which of these options seems most interesting to you? Tell us in the comments",
            "avatar_id" => "avatar_sarah",
            "voice_id" => "voice_en_female_1"
          }
        ],
        "beats" => []
      },
      "assets" => {
        "external_video_url" => "",
        "video_urls" => [],
        "video_prompts" => [],
        "broll_suggestions" => ["People using technology", "Friendly interfaces", "Digital diversity"]
      },
      "accessibility" => { "captions" => true, "srt_export" => true },
      "kpi_focus" => "reach",
      "success_criteria" => "≥10K views",
      "compliance_check" => "ok"
    }
  ]
}

puts "🎭 Simulated Voxa response prepared"
puts "   Items: #{mock_voxa_response["items"].length}"
puts "   First item ID: #{mock_voxa_response["items"][0]["id"]}"
```

```ruby
# Simulate service call with mock response
begin
  # Mock OpenAI response temporarily
  original_method = service.method(:openai_chat!)
  
  def service.openai_chat!(system_msg:, user_msg:)
    # Simulate OpenAI JSON response
    mock_response = {
      "items" => [
        {
          "id" => "20250819-w1-i1",
          "origin_id" => "202508-testbrand-co-w1-i1-C",
          "origin_source" => "weekly_plan",
          "week" => 1,
          "week_index" => 1,
          "content_name" => "Accessible Tech Innovation",
          "status" => "in_production",
          "creation_date" => Date.current.iso8601,
          "publish_date" => (Date.current + 4.days).iso8601,
          "publish_datetime_local" => (Date.current + 4.days).strftime("%Y-%m-%dT18:00:00"),
          "timezone" => "America/New_York",
          "content_type" => "Video",
          "platform" => "Instagram Reels",
          "aspect_ratio" => "9:16",
          "language" => "en-US",
          "pilar" => "C",
          "template" => "only_avatars",
          "video_source" => "none",
          "post_description" => "Educational content about technological accessibility",
          "text_base" => "Did you know technology can be more accessible? Here are 3 ways to democratize access. Which do you prefer? 👇",
          "hashtags" => "#technology #innovation #accessibility #digital",
          "subtitles" => { "mode" => "platform_auto", "languages" => ["en-US"] },
          "dubbing" => { "enabled" => false, "languages" => [] },
          "shotplan" => {
            "scenes" => [
              {
                "id" => 1,
                "role" => "Hook",
                "type" => "avatar",
                "visual" => "Avatar close-up",
                "on_screen_text" => "ACCESSIBLE TECHNOLOGY?",
                "voiceover" => "Did you know technology can be more accessible?",
                "avatar_id" => "avatar_sarah",
                "voice_id" => "voice_en_female_1"
              }
            ],
            "beats" => []
          },
          "assets" => {
            "external_video_url" => "",
            "video_urls" => [],
            "video_prompts" => [],
            "broll_suggestions" => ["Accessible technology"]
          },
          "accessibility" => { "captions" => true, "srt_export" => true },
          "kpi_focus" => "reach",
          "success_criteria" => "≥10K views",
          "compliance_check" => "ok"
        }
      ]
    }
    
    puts "🔄 Simulating OpenAI response..."
    return mock_response
  end
  
  # Execute the service
  result = service.call
  puts "✅ Service executed successfully"
  
rescue => e
  puts "❌ Service error: #{e.message}"
  puts e.backtrace[0..3]
end
```

---

## 📊 6. Verify Content Items Creation

After executing the service, verify that the records were created correctly:

```ruby
# Verify that content items were created
content_items = strategy_plan.creas_content_items.reload

puts "📈 Refinement result:"
puts "   Content items created: #{content_items.count}"

if content_items.any?
  first_item = content_items.first
  puts "\n📝 First content item:"
  puts "   ID: #{first_item.content_id}"
  puts "   Origin: #{first_item.origin_id}"
  puts "   Name: #{first_item.content_name}"
  puts "   Status: #{first_item.status}"
  puts "   Template: #{first_item.template}"
  puts "   Pillar: #{first_item.pilar}"
  puts "   Week: #{first_item.week}"
  
  # Verify dates
  puts "\n📅 Dates:"
  puts "   Creation: #{first_item.creation_date}"
  puts "   Publication: #{first_item.publish_date}"
  puts "   Local publication: #{first_item.publish_datetime_local}"
  
  # Verify content
  puts "\n📄 Content:"
  puts "   Description: #{first_item.post_description[0..100]}..."
  puts "   Base text: #{first_item.text_base[0..100]}..."
  puts "   Hashtags: #{first_item.hashtags}"
  
  # Verify JSONB
  puts "\n🎬 Shotplan:"
  puts "   Scenes: #{first_item.scenes.length}"
  puts "   Beats: #{first_item.beats.length}"
  puts "   First scene: #{first_item.scenes.first&.dig("role")}"
  
  puts "\n📁 Assets:"
  puts "   External videos: #{first_item.external_videos.length}"
  puts "   B-roll suggestions: #{first_item.assets.dig("broll_suggestions")&.length || 0}"
end
```

---

## 🔄 7. Test Idempotency

An important feature is that running Voxa multiple times should not create duplicates:

```ruby
# Count items before second execution
initial_count = strategy_plan.creas_content_items.count
puts "📊 Items before second execution: #{initial_count}"

# Execute the service for the second time
begin
  service = Creas::VoxaContentService.new(strategy_plan: strategy_plan)
  
  # Apply the same mock as before
  def service.openai_chat!(system_msg:, user_msg:)
    mock_response = {
      "items" => [
        {
          "id" => "20250819-w1-i1",
          "origin_id" => "202508-testbrand-co-w1-i1-C",
          "content_name" => "Accessible Tech Innovation UPDATED",  # Change to test update
          "status" => "in_production",
          "creation_date" => Date.current.iso8601,
          "publish_date" => (Date.current + 4.days).iso8601,
          "publish_datetime_local" => (Date.current + 4.days).strftime("%Y-%m-%dT18:00:00"),
          "timezone" => "America/New_York",
          "content_type" => "Video",
          "platform" => "Instagram Reels",
          "aspect_ratio" => "9:16",
          "language" => "en-US",
          "pilar" => "C",
          "template" => "only_avatars",
          "video_source" => "none",
          "post_description" => "Updated description",
          "text_base" => "Updated base text",
          "hashtags" => "#technology #updated",
          "shotplan" => { "scenes" => [], "beats" => [] },
          "assets" => { "broll_suggestions" => [] },
          "subtitles" => { "mode" => "platform_auto", "languages" => ["en-US"] },
          "dubbing" => { "enabled" => false, "languages" => [] },
          "accessibility" => { "captions" => true },
          "kpi_focus" => "reach",
          "success_criteria" => "≥10K views",
          "compliance_check" => "ok",
          "origin_source" => "weekly_plan",
          "week" => 1,
          "week_index" => 1
        }
      ]
    }
    return mock_response
  end
  
  result = service.call
  puts "✅ Second execution completed"
  
rescue => e
  puts "❌ Error in second execution: #{e.message}"
end

# Verify idempotency
final_count = strategy_plan.creas_content_items.reload.count
puts "📊 Items after second execution: #{final_count}"

if final_count == initial_count
  puts "✅ Idempotency confirmed - no duplicates created"
  
  # Verify if content was updated
  updated_item = strategy_plan.creas_content_items.find_by(content_id: "20250819-w1-i1")
  if updated_item&.content_name&.include?("UPDATED")
    puts "✅ Update confirmed - content was modified"
  else
    puts "ℹ️ No changes detected in content"
  end
else
  puts "⚠️ #{final_count - initial_count} additional items created - verify idempotency logic"
end
```

---

## 🎨 8. Test ContentItemFormatter

The formatter converts content items into frontend-friendly format:

```ruby
# Take the first content item
content_item = strategy_plan.creas_content_items.first

if content_item
  # Use the class formatter
  formatted_hash = Creas::ContentItemFormatter.call(content_item)
  
  puts "🎨 Content formatted for frontend:"
  puts "   ID: #{formatted_hash[:id]}"
  puts "   Origin: #{formatted_hash[:origin_id]}"
  puts "   Name: #{formatted_hash[:content_name]}"
  puts "   Status: #{formatted_hash[:status]}"
  
  # Verify date formatting
  puts "\n📅 Formatted dates:"
  puts "   Creation: #{formatted_hash[:creation_date]}"
  puts "   Publication: #{formatted_hash[:publish_date]}"
  
  # Verify hashtag formatting
  puts "\n🏷️ Formatted hashtags:"
  puts "   Array: #{formatted_hash[:hashtags].inspect}"
  puts "   Type: #{formatted_hash[:hashtags].class}"
  
  # Verify derived meta fields
  puts "\n📊 Metadata:"
  puts "   KPI Focus: #{formatted_hash[:kpi_focus]}"
  puts "   Success criteria: #{formatted_hash[:success_criteria]}"
  puts "   Compliance: #{formatted_hash[:compliance_check]}"
  
  # Verify scenes/beats structure by template
  if content_item.template == "only_avatars"
    puts "\n🎭 Scenes (only_avatars):"
    puts "   Count: #{formatted_hash[:scenes].length}"
    puts "   First scene: #{formatted_hash[:scenes].first&.dig(:role)}"
  elsif content_item.template == "narration_over_7_images"
    puts "\n🖼️ Beats (narration_over_7_images):"
    puts "   Count: #{formatted_hash[:beats].length}"
  end
  
else
  puts "❌ No content items to format"
end
```

---

## 🧹 9. Statistics and Cleanup

Generate final statistics and prepare for cleanup:

```ruby
# Strategy plan statistics
stats = strategy_plan.content_stats
puts "📊 Content statistics:"
stats.each do |(status, template, video_source), count|
  puts "   #{status} | #{template} | #{video_source}: #{count} items"
end

# Current week items (if we're in August 2025)
current_week_items = strategy_plan.current_week_items
puts "\n📅 Current week items: #{current_week_items.count}"

# Summary by pillar
pillar_counts = strategy_plan.creas_content_items.group(:pilar).count
puts "\n🏛️ Distribution by CREAS pillar:"
%w[C R E A S].each do |pilar|
  count = pillar_counts[pilar] || 0
  puts "   #{pilar}: #{count} items"
end

# Summary by template
template_counts = strategy_plan.creas_content_items.group(:template).count
puts "\n🎬 Distribution by template:"
template_counts.each do |template, count|
  puts "   #{template}: #{count} items"
end
```

```ruby
# Show all created content_ids
content_ids = strategy_plan.creas_content_items.pluck(:content_id)
puts "\n🆔 Content IDs created:"
content_ids.each { |id| puts "   - #{id}" }

puts "\n✅ Complete Voxa test finished"
puts "   Total items created: #{strategy_plan.creas_content_items.count}"
puts "   Strategy plan: #{strategy_plan.id}"
puts "   User: #{user.email}"
puts "   Brand: #{brand.name}"
```

## 🗑️ Cleanup (Optional)

To clean up test data after finishing:

```ruby
# ⚠️ CAUTION: This will delete all test data
puts "🗑️ To clean up test data, execute:"
puts ""
puts "# Delete content items"
puts "strategy_plan.creas_content_items.destroy_all"
puts ""
puts "# Delete strategy plan"
puts "strategy_plan.destroy"
puts ""
puts "# Delete brand and channels"
puts "brand.brand_channels.destroy_all"
puts "brand.destroy"
puts ""
puts "# Delete user (if it's a test user)"
puts "user.destroy if user.email == 'test@example.com'"

# Uncomment the following lines to execute cleanup:
# strategy_plan.creas_content_items.destroy_all
# strategy_plan.destroy
# brand.brand_channels.destroy_all  
# brand.destroy
# user.destroy if user.email == 'test@example.com'
# puts "✅ Test data deleted"
```

---

## 🎯 Success Criteria

If all the above steps worked correctly, you should see:

- ✅ **User and brand created** with complete data
- ✅ **Strategy plan** with realistic Noctua payload  
- ✅ **StrategyPlanFormatter** generating correct structure for Voxa
- ✅ **Brand context** built with platforms and guardrails
- ✅ **Voxa prompts** generated with expected structure
- ✅ **CreasContentItems** created in database
- ✅ **Idempotency** confirmed (no duplicates on second execution)
- ✅ **ContentItemFormatter** transforming data for frontend
- ✅ **Statistics** showing correct distribution by pillar and template

## ⚠️ Common Problems and Solutions

### "NoMethodError: undefined method for_voxa"
- **Cause:** StrategyPlanFormatter doesn't have the `for_voxa` method  
- **Solution:** Verify that the method is implemented in the formatter

### "ActiveRecord::RecordInvalid: Validation failed"
- **Cause:** Mock data doesn't meet model validations
- **Solution:** Review validations in `CreasContentItem` and adjust the mock

### "KeyError: key not found: items"
- **Cause:** OpenAI response doesn't have expected structure
- **Solution:** Verify mock response format and prompts

### "Association not found" 
- **Cause:** Model references are not correct
- **Solution:** Verify that user, brand, and strategy_plan are correctly related

---

**Ready!** With this guide you can test step by step the entire Voxa implementation and understand how each component of the system works.